<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TransUnion Report Extractor v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        .loader { border-top-color: #3b82f6; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 font-sans">

    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden border border-slate-200">
            <header class="bg-slate-900 p-8 text-white">
                <h1 class="text-3xl font-extrabold tracking-tight italic text-blue-400">Statutory <span class="text-white">Report Reader</span></h1>
                <p class="text-slate-400 mt-1">Extracting providers and balances from TransUnion reports</p>
            </header>

            <div class="p-6 md:p-8">
                <div class="mb-8 p-10 border-2 border-dashed border-slate-300 bg-slate-50 rounded-2xl text-center hover:border-blue-500 hover:bg-blue-50 transition-all cursor-pointer">
                    <input type="file" id="fileInput" accept="image/*,application/pdf" class="hidden" multiple>
                    <label for="fileInput" class="cursor-pointer block">
                        <div class="text-slate-700 font-bold text-xl">Upload PDF or Images</div>
                        <div class="text-sm text-slate-500 mt-2 italic">Optimized for table-based credit reports</div>
                    </label>
                </div>

                <div id="status" class="hidden flex flex-col items-center py-10">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-200 h-12 w-12 mb-4"></div>
                    <p class="text-slate-600 font-medium animate-pulse" id="statusText">Scanning...</p>
                </div>

                <div id="resultArea" class="hidden space-y-6">
                    <div id="outputContent" class="bg-slate-900 rounded-xl p-8 text-slate-300 font-mono text-sm shadow-2xl">
                        <h2 class="text-white text-xl font-bold mb-6 border-b border-slate-700 pb-4">Financial Account Summary</h2>
                        <div id="summaryList" class="space-y-2 border-l-2 border-slate-800 ml-2 pl-4 mb-8"></div>
                        <div class="pt-6 border-t border-slate-700 flex justify-between items-end text-white">
                            <span class="text-slate-400 font-bold uppercase tracking-widest text-xs">Total Liabilities Found:</span>
                            <span id="totalValue" class="text-4xl font-black text-yellow-400">£0</span>
                        </div>
                    </div>
                    <button id="copyBtn" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 shadow-lg">Copy Clean Summary Text</button>
                </div>
            </div>
        </div>
    </div>
    <canvas id="pdfCanvas" class="hidden"></canvas>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('status');
        const statusText = document.getElementById('statusText');
        const resultArea = document.getElementById('resultArea');
        const summaryList = document.getElementById('summaryList');
        const totalValue = document.getElementById('totalValue');
        const pdfCanvas = document.getElementById('pdfCanvas');

        let grandTotal = 0;
        let seenItems = new Set();

        fileInput.addEventListener('change', async (e) => {
            const files = e.target.files;
            if (!files.length) return;
            status.classList.remove('hidden');
            resultArea.classList.add('hidden');
            summaryList.innerHTML = '';
            grandTotal = 0;
            seenItems.clear();

            for (let file of files) {
                statusText.innerText = `Processing ${file.name}...`;
                if (file.type === "application/pdf") {
                    await processPdf(file);
                } else {
                    await processImage(file);
                }
            }
            status.classList.add('hidden');
            resultArea.classList.remove('hidden');
            totalValue.innerText = `£${grandTotal.toLocaleString()}`;
        });

        async function processPdf(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            for (let i = 1; i <= pdf.numPages; i++) {
                statusText.innerText = `Scanning Page ${i} of ${pdf.numPages}...`;
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 2.0 });
                const ctx = pdfCanvas.getContext('2d');
                pdfCanvas.height = viewport.height;
                pdfCanvas.width = viewport.width;
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                await processImage(pdfCanvas.toDataURL());
            }
        }

        async function processImage(imageSource) {
            const worker = await Tesseract.createWorker();
            await worker.loadLanguage('eng');
            await worker.initialize('eng');
            const { data: { lines } } = await worker.recognize(imageSource);
            
            lines.forEach((line) => {
                let text = line.text.trim();
                // 1. Detect currency values like £228 or £1,407
                const currencyMatch = text.match(/[£EB&]\s*([\d,]+)/);
                
                if (currencyMatch) {
                    const amount = parseFloat(currencyMatch[1].replace(/,/g, ''));
                    // 2. Extract provider (text before the currency symbol)
                    let provider = text.split(/[£EB&]/)[0].trim();
                    
                    // 3. Filter out noise (Headers, dates, empty names)
                    if (provider && provider.length > 2 && !provider.match(/ORGANISATION|BALANCE|UPDATED/i)) {
                        // Avoid duplicates from same page
                        const key = `${provider}-${amount}`;
                        if (!seenItems.has(key)) {
                            addRow(provider, amount);
                            grandTotal += amount;
                            seenItems.add(key);
                        }
                    } else if (text.toUpperCase().includes("AMOUNT") && amount > 0) {
                        // Catch CCJs where the word "Amount" is used
                        addRow("Court Judgment (CCJ)", amount);
                        grandTotal += amount;
                    }
                }
            });
            await worker.terminate();
        }

        function addRow(name, price) {
            const div = document.createElement('div');
            div.className = "flex justify-between py-1 border-b border-slate-800/50 item-row";
            div.setAttribute('data-name', name);
            div.setAttribute('data-price', price.toLocaleString());
            div.innerHTML = `<span>${name}</span> <span class="text-white">£${price.toLocaleString()}</span>`;
            summaryList.appendChild(div);
        }

        document.getElementById('copyBtn').addEventListener('click', () => {
            let output = "Financial Account Summary\n==========================\n\n";
            document.querySelectorAll('.item-row').forEach(el => {
                output += `${el.getAttribute('data-name')} — £${el.getAttribute('data-price')}\n`;
            });
            output += `\nTOTAL LIABILITIES: £${totalValue.innerText.replace('£', '')}`;
            navigator.clipboard.writeText(output).then(() => alert('Summary copied to clipboard!'));
        });
    </script>
</body>
</html>
