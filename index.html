<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debt Extractor Command Center V8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        .loader { border-top-color: #3b82f6; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 md:p-8 font-sans">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-200">
            <header class="bg-slate-900 p-8 text-white flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-extrabold tracking-tight text-blue-400 italic">Precision <span class="text-white">Command Center</span></h1>
                    <p class="text-slate-400 mt-1">Auto-Labeling CCJs & Intelligent Prompting</p>
                </div>
                <button onclick="clearAllData()" class="bg-red-500/10 hover:bg-red-500/20 text-red-400 px-4 py-2 rounded-xl text-xs font-bold uppercase">Clear History</button>
            </header>

            <div class="p-6 md:p-8">
                <div class="mb-6 bg-blue-50 p-6 rounded-2xl border border-blue-100">
                    <h3 class="text-blue-800 font-bold text-sm mb-2 flex items-center">
                        <span class="mr-2">⚡</span> Command Prompt
                    </h3>
                    <div class="flex gap-2">
                        <input type="text" id="cmdInput" placeholder="Try: 'Rename Active to CCJ' or 'Change 622 to Perch Capital'" class="flex-1 p-3 rounded-xl border border-blue-200 focus:ring-2 focus:ring-blue-400 outline-none">
                        <button onclick="executeCommand()" class="bg-blue-600 text-white px-6 rounded-xl font-bold hover:bg-blue-700">Run</button>
                    </div>
                    <p class="text-[10px] text-blue-400 mt-2 italic">Commands supported: **Rename**, **Replace**, **Change**, or simply **Add**.</p>
                </div>

                <div class="mb-8 p-10 border-4 border-dashed border-slate-200 bg-slate-50 rounded-3xl text-center hover:border-blue-400 cursor-pointer">
                    <input type="file" id="fileIn" accept="image/*,application/pdf" class="hidden" multiple>
                    <label for="fileIn" class="cursor-pointer block">
                        <div class="text-slate-800 font-bold text-xl">Upload Documents</div>
                        <p class="text-slate-500 mt-1">Automatically identifies CCJs from headings</p>
                    </label>
                </div>

                <div id="status" class="hidden flex flex-col items-center py-6">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-200 h-10 w-10 mb-2"></div>
                    <p class="text-slate-600 text-sm font-bold" id="statusText">Analyzing Patterns...</p>
                </div>

                <div id="resArea" class="space-y-6">
                    <div class="bg-slate-900 rounded-2xl p-8 text-slate-300 font-mono text-sm">
                        <div class="border-b border-slate-800 pb-4 mb-6">
                            <h2 class="text-white text-xl font-bold">Verified Outstanding Debt</h2>
                        </div>
                        <div id="extractedContent" class="space-y-2"></div>
                        <div class="mt-8 pt-6 border-t border-slate-700 flex justify-between items-end">
                            <span class="text-slate-500 font-bold uppercase tracking-widest text-xs">Total Balance</span>
                            <span id="grandTotal" class="text-5xl font-black text-yellow-400">£0</span>
                        </div>
                    </div>
                    <button id="copyBtn" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold hover:bg-slate-700">Copy Summary</button>
                </div>
            </div>
        </div>
    </div>
    <canvas id="canvas" class="hidden"></canvas>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        let dataHistory = JSON.parse(localStorage.getItem('debtHistoryV8')) || [];
        const extractedContent = document.getElementById('extractedContent');
        const grandTotalDisplay = document.getElementById('grandTotal');

        window.onload = renderAll;

        document.getElementById('fileIn').addEventListener('change', async (e) => {
            document.getElementById('status').classList.remove('hidden');
            for (let file of e.target.files) {
                if (file.type === "application/pdf") await handlePdf(file);
                else await handleImage(file);
            }
            document.getElementById('status').classList.add('hidden');
            saveAndRender();
        });

        async function handlePdf(file) {
            const data = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(data).promise;
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 2.0 });
                const ctx = canvas.getContext('2d');
                canvas.height = viewport.height; canvas.width = viewport.width;
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                await processOCR(canvas.toDataURL());
            }
        }

        async function handleImage(file) {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = async (e) => { await processOCR(e.target.result); resolve(); };
                reader.readAsDataURL(file);
            });
        }

        async function processOCR(src) {
            const worker = await Tesseract.createWorker();
            await worker.loadLanguage('eng'); await worker.initialize('eng');
            const { data: { lines } } = await worker.recognize(src);
            
            let isCCJSection = false;

            for (let i = 0; i < lines.length; i++) {
                let text = lines[i].text.trim();
                
                // Detect CCJ Heading
                if (text.match(/County Court Judgment|Judgments/i)) isCCJSection = true;
                
                // Detect Balances
                if (text.match(/Balance|Amount owed|Amount/i)) {
                    let amt = null;
                    const sameLine = text.match(/([\d,]{2,10}(?:\.\d{2})?)/);
                    let nextLine = (i + 1 < lines.length) ? lines[i+1].text.trim() : "";
                    const nextLineMatch = nextLine.match(/^[\d,]{2,10}(?:\.\d{2})?$/);

                    if (sameLine) amt = parseFloat(sameLine[1].replace(/,/g,''));
                    else if (nextLineMatch) amt = parseFloat(nextLineMatch[0].replace(/,/g,''));

                    if (amt && amt < 100000 && amt > 1 && ![2024, 2025, 2026].includes(amt)) {
                        let name = isCCJSection ? "CCJ" : (text.split(/Balance|Amount/i)[0].trim() || lines[i-1].text.trim());
                        addToData(name.replace(/STATUS|ACTIVE|UPDATED/gi, '').trim(), amt);
                        if (isCCJSection) isCCJSection = false; // Reset for next section
                    }
                }
            }
            await worker.terminate();
        }

        function executeCommand() {
            const input = document.getElementById('cmdInput').value.toLowerCase();
            
            // RENAME COMMAND: "Rename Active to CCJ"
            if (input.includes("rename") || input.includes("change")) {
                const parts = input.split(/rename|change|to/);
                const oldName = parts[1].trim();
                const newName = parts[2].trim();
                dataHistory.forEach(item => {
                    if (item.name.toLowerCase().includes(oldName)) item.name = newName.toUpperCase();
                });
            } 
            // ADD/REPLACE LOGIC
            else {
                const amountMatch = input.match(/(\d[\d,.]*)/);
                if (amountMatch) {
                    const amt = parseFloat(amountMatch[0].replace(/,/g, ''));
                    const name = input.replace(amountMatch[0], '').replace(/add|replace/g, '').trim();
                    addToData(name.toUpperCase(), amt);
                }
            }
            document.getElementById('cmdInput').value = "";
            saveAndRender();
        }

        function addToData(name, amount) {
            const exists = dataHistory.some(item => item.name === name && item.amount === amount);
            if (!exists && name.length > 1) {
                dataHistory.push({ id: Date.now() + Math.random(), name, amount });
            }
        }

        function removeItem(id) {
            dataHistory = dataHistory.filter(item => item.id !== id);
            saveAndRender();
        }

        function clearAllData() { if(confirm("Clear history?")) { dataHistory = []; saveAndRender(); } }

        function saveAndRender() {
            localStorage.setItem('debtHistoryV8', JSON.stringify(dataHistory));
            renderAll();
        }

        function renderAll() {
            extractedContent.innerHTML = '';
            let total = 0;
            dataHistory.forEach(item => {
                total += item.amount;
                const row = document.createElement('div');
                row.className = "flex justify-between items-center py-2 border-b border-slate-800/40 px-2 group";
                row.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-slate-500 uppercase text-[10px] font-bold">${item.name}</span>
                        <span class="text-white font-black text-lg">£${item.amount.toLocaleString()}</span>
                    </div>
                    <button onclick="removeItem(${item.id})" class="text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-all">✕</button>
                `;
                extractedContent.appendChild(row);
            });
            grandTotalDisplay.innerText = `£${total.toLocaleString()}`;
        }

        document.getElementById('copyBtn').addEventListener('click', () => {
            let log = "DEBT REPORT\n-----------\n";
            dataHistory.forEach(item => log += `${item.name}: £${item.amount.toLocaleString()}\n`);
            log += `\nTOTAL: ${grandTotalDisplay.innerText}`;
            navigator.clipboard.writeText(log).then(() => alert("Copied!"));
        });
    </script>
</body>
</html>
